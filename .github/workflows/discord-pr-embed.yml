name: Discord PR Notifications

on:
  pull_request:
    types: [opened, closed]  # opened = created, closed = merged or closed unmerged

jobs:
  discord:
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord PR Notification
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const webhookUrl = '${{ secrets.DISCORD_WEBHOOK }}';
            const pr = github.event.pull_request;
            const action = github.event.action;

            // ---------------------------
            // PR CREATED
            // ---------------------------
            if (action === 'opened') {
              const embed = {
                title: `üì¨ New PR: ${pr.title}`,
                url: pr.html_url,
                color: 0x00ff00,
                author: { name: pr.user.login, icon_url: pr.user.avatar_url },
                fields: [
                  { name: 'Branch', value: pr.head.ref, inline: true },
                  { name: 'Base', value: pr.base.ref, inline: true }
                ],
                timestamp: new Date()
              };

              await fetch(webhookUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ embeds: [embed] })
              });
            }

            // ---------------------------
            // PR MERGED (any branch)
            // ---------------------------
            if (action === 'closed' && pr.merged) {
              const embed = {
                title: `‚úÖ PR Merged: ${pr.title}`,
                url: pr.html_url,
                color: 0x0000ff,
                author: { name: pr.user.login, icon_url: pr.user.avatar_url },
                fields: [
                  { name: 'Merged into', value: pr.base.ref, inline: true },
                  { name: 'Branch', value: pr.head.ref, inline: true }
                ],
                timestamp: new Date()
              };

              await fetch(webhookUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ embeds: [embed] })
              });
            }

            // ---------------------------
            // PR CLOSED WITHOUT MERGE (optional)
            // ---------------------------
            if (action === 'closed' && !pr.merged) {
              const embed = {
                title: `‚ùå PR Closed: ${pr.title}`,
                url: pr.html_url,
                color: 0xff0000,
                author: { name: pr.user.login, icon_url: pr.user.avatar_url },
                fields: [
                  { name: 'Branch', value: pr.head.ref, inline: true },
                  { name: 'Base', value: pr.base.ref, inline: true }
                ],
                timestamp: new Date()
              };

              await fetch(webhookUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ embeds: [embed] })
              });
            }
