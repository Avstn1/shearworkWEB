name: Discord Notifications

on:
  pull_request:
    types: [opened, closed, reopened]
  push:
    branches: 
      - main  # remove or add branches as needed

jobs:
  discord:
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord Notification
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const webhookUrl = '${{ secrets.DISCORD_WEBHOOK }}';

            if (github.event_name === 'pull_request') {
              const pr = github.event.pull_request;
              let color = 0x00ff00; // green
              let action = github.event.action;

              if (action === 'closed') {
                if (pr.merged) {
                  color = 0x0000ff; // blue for merged
                  action = 'merged';
                } else {
                  color = 0xff0000; // red for closed/unmerged
                }
              }

              const embed = {
                title: pr.title,
                url: pr.html_url,
                color: color,
                author: { name: pr.user.login, icon_url: pr.user.avatar_url },
                fields: [
                  { name: 'Action', value: action, inline: true },
                  { name: 'Branch', value: pr.head.ref, inline: true },
                  { name: 'Base', value: pr.base.ref, inline: true }
                ],
                timestamp: new Date()
              };

              await fetch(webhookUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ embeds: [embed] })
              });

            } else if (github.event_name === 'push') {
              const commits = github.event.commits
                .map(c => `- ${c.message} (${c.author.name})`)
                .join('\n');

              const embed = {
                title: `Push to ${github.ref.replace('refs/heads/', '')}`,
                url: github.event.compare,
                color: 0x00ffff,
                description: commits || 'No commit messages',
                timestamp: new Date()
              };

              await fetch(webhookUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ embeds: [embed] })
              });
            }
